# 工作流名称
name: PyInstaller Windows

# 设置权限
permissions:
  contents: write  # 允许创建 release
  packages: write  # 允许上传 artifacts
  actions: write   # 允许管理工作流

# 触发条件配置
on:
  push:
    tags:
      - v*  # 当推送以v开头的tag时触发（如v1.0.0）
  
  # 允许手动触发工作流
  workflow_dispatch:

# 工作定义
jobs:
  build-windows:
    # 使用Windows最新版运行环境
    runs-on: windows-latest
    
    steps:
      # 第一步：检出代码
      - name: Checkout
        uses: actions/checkout@v4
        
      # 第二步：安装Python
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.10'  # 指定Python版本
          architecture: 'x64'       # 64位架构
          
      # 第三步：安装依赖
      - name: Install requirements and installer
        run: |
          pip install -r requirements.txt
          
      # 第四步：使用PyInstaller打包
      - name: Run pyinstaller
        run: |
          python -m PyInstaller server.spec  # 使用spec文件打包
          ls -R dist  # 列出dist目录内容用于调试
          
      # 第五步：上传构建产物（已注释，跳过上传）
      # - uses: actions/upload-artifact@v5
      #   with:
      #     name: app
      #     path: dist/*  # 上传dist目录下所有文件
      #     retention-days: 3  # 保留7天
          
      # 第六步：使用tag名称压缩文件
      - name: zip the artifect dir into a zip
        run: |
          ls -R dist
          # 使用推送的tag名称作为压缩包名（如v1.0.0.zip）
          powershell Compress-Archive ${{ github.workspace }}/dist/* ${{ github.workspace }}/dist/${{ github.ref_name }}.zip
          
      # 第七步：创建GitHub Release并上传
      - name: create release and upload
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 使用GitHub Token认证
        with:
          tag_name: ${{ github.ref_name }}  # 使用推送的tag名称
          name: Release ${{ github.ref_name }}  # Release名称
          body: AFKOS Release  # Release描述
          files: dist/${{ github.ref_name }}.zip  # 上传的压缩包
          draft: false  # 非草稿模式
          prerelease: false  # 非预发布
          fail_on_unmatched_files: false  # 文件不匹配时不报错